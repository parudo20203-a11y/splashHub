-- ====================================================================
-- SplashHub: UIä»˜ãçµ±åˆå®‰å®šç‰ˆ
-- ç›®çš„: UIã¨é€šçŸ¥ã‚’å¾©å…ƒã—ã¤ã¤ã€é˜²å¾¡æ©Ÿèƒ½ã¨èµ·å‹•å®‰å®šæ€§ã‚’æœ€å¤§åŒ–
-- ====================================================================
local P = game:GetService("Players").LocalPlayer;
local UIS = game:GetService("UserInputService");
local RS = game:GetService("RunService");
local WS = game:GetService("Workspace");
local ReplicatedStorage = game:GetService("ReplicatedStorage");

if not P then return end;

local WALK_SPEED = 32;
local FLY_SPEED = 40;
local MAX_FAILURES = 5;
local GRAB_DETECTION_OBJECTS = {"BodyPosition", "BodyVelocity", "BodyGyro", "AlignOrientation", "AlignPosition", "Attachment"};
-- æ´ã¿ã‚¤ãƒ™ãƒ³ãƒˆã¨è¦–ç‚¹ãƒªã‚»ãƒƒãƒˆã‚¤ãƒ™ãƒ³ãƒˆã®ãƒ•ãƒƒã‚¯å¯¾è±¡
local GRAB_EVENTS = {"GrabEvents.ExtendGrabLine", "CharacterEvents.Look"};

local isFlying = false;
local bodyVelocity = nil;
local controlButton = nil;
local speedTextBox = nil;
local MainFrame = nil;
local anticheatBinding = nil;
local flyLoopBinding = nil;
local antiragdollBinding = nil;
local grabDetectionConnection = nil;
local isDragging = false;
local dragOffset = nil;
local failureCount = 0;

-- é€šçŸ¥æ©Ÿèƒ½ (UIæ©Ÿèƒ½ã®å®‰å®šæ€§ã‚’é«˜ã‚ã‚‹ãŸã‚ã€pcallã‚’å¤šç”¨)
local function showNotification(message, color)
    local G = Instance.new("ScreenGui");
    if not P.PlayerGui then return end
    pcall(function() G.Parent = P.PlayerGui; G.Name = "SplashHubNotify"; end);
    if not G.Parent then return end; -- è¦ªã®è¨­å®šå¤±æ•—ã‚’ãƒã‚§ãƒƒã‚¯

    local NF = Instance.new("Frame");
    local T = Instance.new("TextLabel");

    pcall(function()
        NF.Parent = G;
        NF.Size = UDim2.new(0, 300, 0, 50);
        NF.Position = UDim2.new(1, 0, 1, -50);
        NF.BackgroundColor3 = Color3.new(0.2, 0.2, 0.2);
        NF.BackgroundTransparency = 0.1;

        T.Parent = NF;
        T.Size = UDim2.new(1, 0, 1, 0);
        T.BackgroundTransparency = 0.8;
        T.Text = message;
        T.TextColor3 = color or Color3.fromRGB(255, 255, 255);
        T.Font = Enum.Font.SourceSansBold;
        T.TextSize = 18;
    end);

    pcall(NF.TweenPosition, NF, UDim2.new(1, -310, 1, -50), "Out", "Quart", 0.3, true);

    spawn(function()
        wait(3);
        pcall(NF.TweenPosition, NF, UDim2.new(1, 0, 1, -50), "In", "Quart", 0.3, true);
        wait(0.3);
        if G and G.Parent then pcall(G.Destroy, G) end;
    end);
end;

-- æ´ã¿/é˜²å¾¡RemoteEventã®ç„¡åŠ¹åŒ–ï¼ˆHookï¼‰
local function hookGrabEvents()
    for _, path in pairs(GRAB_EVENTS) do
        local parts = string.split(path, ".");
        local eventName = table.remove(parts);
        local current = ReplicatedStorage;

        for _, part in ipairs(parts) do
            current = current:WaitForChild(part, 3);
            if not current then break end
        end

        local event = current and current:FindFirstChild(eventName);

        if event and event:IsA("RemoteEvent") then
            local success, _ = pcall(function()
                event.OnClientEvent:Connect(function()
                    -- ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒ‰ãƒ­ãƒƒãƒ—ã•ã›ã‚‹
                end);
            end)
            if success then
                showNotification("ğŸ”’ é˜²å¾¡ã‚¤ãƒ™ãƒ³ãƒˆ (" .. path .. ") ã‚’ãƒ•ãƒƒã‚¯ã—ã¾ã—ãŸã€‚", Color3.fromRGB(0, 255, 255));
            else
                 showNotification("é˜²å¾¡ã‚¤ãƒ™ãƒ³ãƒˆ (" .. path .. ") ã®ãƒ•ãƒƒã‚¯ã«å¤±æ•—ã€‚", Color3.fromRGB(255, 150, 0));
            end
        else
            showNotification("é˜²å¾¡ã‚¤ãƒ™ãƒ³ãƒˆ (" .. path .. ") ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚", Color3.fromRGB(255, 150, 0));
        end
    end
end

-- æ´ã¿ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®æ¤œçŸ¥ã¨ç ´å£Š
local function setupGrabDetection(rootPart)
    if grabDetectionConnection and grabDetectionConnection.Connected then grabDetectionConnection:Disconnect(); end
    grabDetectionConnection = rootPart.ChildAdded:Connect(function(child)
        for _, name in pairs(GRAB_DETECTION_OBJECTS) do
            if child.ClassName == name and child.Parent == rootPart then
                showNotification("â›” æ´ã¿ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæŒ¿å…¥æ¤œå‡ºï¼è„±å‡ºã‚’è©¦ã¿ã¾ã™ã€‚", Color3.fromRGB(255, 150, 0));
                pcall(child.Destroy, child);
            end
        end
    end);
end

-- æ•µã‚¹ã‚¯ãƒªãƒ—ãƒˆç„¡åŠ¹åŒ–æ©Ÿèƒ½
local function disableTargetScript()
    local playerScripts = P:FindFirstChild("PlayerScripts");
    if not playerScripts then return end
    local targetScript = playerScripts:FindFirstChild("CharacterAndBeamMove");
    if targetScript then
        local success, _ = pcall(function() targetScript:Destroy(); end)
        if success then showNotification("æ•µã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ç„¡åŠ¹åŒ–ã—ã¾ã—ãŸã€‚", Color3.fromRGB(0, 255, 0));
        else pcall(function() targetScript.Disabled = true end); showNotification("æ•µã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å‰Šé™¤ã«å¤±æ•—ã€‚ç„¡åŠ¹åŒ–ã‚’è©¦ã¿ã¾ã—ãŸã€‚", Color3.fromRGB(255, 100, 100)); end
    else showNotification("æ•µã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚", Color3.fromRGB(150, 150, 150)); end
end

-- é£›è¡Œæ©Ÿèƒ½
local function stopFlying()
    if not isFlying then return end;
    isFlying = false; failureCount = 0;
    if anticheatBinding then pcall(RS.UnbindFromRenderStep, RS, "AntiAC"); anticheatBinding = nil end;
    local H = P.Character and P.Character:FindFirstChildOfClass("Humanoid");
    if H and H.Parent then pcall(function() H.WalkSpeed = WALK_SPEED end) end;
    if bodyVelocity and bodyVelocity.Parent then pcall(bodyVelocity.Destroy, bodyVelocity); bodyVelocity = nil end;
    if controlButton then pcall(function() controlButton.Text = "SplashHub: é£›è¡Œåˆ‡ã‚Šæ›¿ãˆ" end) end;
    showNotification("SplashHub: é£›è¡Œ OFF", Color3.fromRGB(255, 100, 100));
end;

local function startFlying()
    if isFlying then return end;
    local H = P.Character and P.Character:FindFirstChildOfClass("Humanoid");
    local Root = P.Character and P.Character:FindFirstChild("HumanoidRootPart");
    if not H or not Root or not Root.Parent then showNotification("ã‚¨ãƒ©ãƒ¼: ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚", Color3.fromRGB(255, 0, 0)); return end;
    isFlying = true;
    pcall(function() H.WalkSpeed = 0 end)
    if not bodyVelocity or not bodyVelocity.Parent then
        bodyVelocity = Root:FindFirstChildOfClass("BodyVelocity") or Instance.new("BodyVelocity");
        bodyVelocity.MaxForce = Vector3.new(1, 1, 1) * 9e9; bodyVelocity.P = 1000;
        pcall(function() bodyVelocity.Parent = Root end)
    end
    anticheatBinding = RS:BindToRenderStep("AntiAC", Enum.RenderPriority.Camera.Value, function()
        if not P.Character or not Root or not Root.Parent or not H or not H.Parent then stopFlying(); return end;
        if H.WalkSpeed ~= 0 then
            pcall(function() H.WalkSpeed = 0 end)
            if H.WalkSpeed ~= 0 then
                failureCount = failureCount + 1;
                if failureCount >= MAX_FAILURES then showNotification("ã‚¢ãƒ³ãƒãƒãƒ¼ãƒˆæ¤œå‡ºã€‚é£›è¡Œã‚’è§£é™¤ã—ã¾ã™ã€‚", Color3.fromRGB(255, 50, 50)); stopFlying(); return end
            end
        else failureCount = 0; end
        if bodyVelocity and not bodyVelocity.Parent then pcall(function() bodyVelocity.Parent = Root end); end;
    end);
    if controlButton then pcall(function() controlButton.Text = "SplashHub: é£›è¡Œåˆ‡ã‚Šæ›¿ãˆ" end) end;
    showNotification("SplashHub: é£›è¡Œ ON", Color3.fromRGB(100, 255, 100));
end;

local function updateFlyMovement()
    if not isFlying or not P.Character or not P.Character:FindFirstChildOfClass("Humanoid") then stopFlying(); return end;
    if not bodyVelocity or not bodyVelocity.Parent then stopFlying(); return end;
    local C = WS.CurrentCamera; if not C then return end;
    local CF_ = C.CFrame; local mV = Vector3.new(0, 0, 0);
    if UIS:IsKeyDown(Enum.KeyCode.W) then mV = mV + CF_.LookVector end;
    if UIS:IsKeyDown(Enum.KeyCode.S) then mV = mV - CF_.LookVector end;
    if UIS:IsKeyDown(Enum.KeyCode.A) then mV = mV - CF_.RightVector end;
    if UIS:IsKeyDown(Enum.KeyCode.D) then mV = mV + CF_.RightVector end;
    if UIS:IsKeyDown(Enum.KeyCode.Space) then mV = mV + Vector3.new(0, 1, 0) end;
    if UIS:IsKeyDown(Enum.KeyCode.LeftShift) or UIS:IsKeyDown(Enum.KeyCode.RightShift) then mV = mV - Vector3.new(0, 1, 0) end;
    if mV.Magnitude > 0 then
        pcall(function() bodyVelocity.Velocity = mV.unit * FLY_SPEED end);
    else
        pcall(function() bodyVelocity.Velocity = Vector3.new(0, 0, 0) end);
    end;
end;


-- ãƒ©ã‚°ãƒ‰ãƒ¼ãƒ«ç„¡åŠ¹åŒ–å‡¦ç† (å¸¸æ™‚å®Ÿè¡Œ)
local function updateAntiRagdoll()
    local H = P.Character and P.Character:FindFirstChildOfClass("Humanoid");
    if H and H.Parent then
        if H.PlatformStand == true then
             pcall(function() H.PlatformStand = false; end);
             showNotification("âš¡ PlatformStandã‚’å³åº§ã«è§£é™¤ã—ã¾ã—ãŸï¼", Color3.fromRGB(255, 255, 0));
        end
        pcall(function() H.PlatformStand = false end);
    end;
end;


-- UI/ãƒ‰ãƒ©ãƒƒã‚°æ©Ÿèƒ½
local function startDrag(input) isDragging = true; dragOffset = input.Position - Vector2.new(MainFrame.AbsolutePosition.X, MainFrame.AbsolutePosition.Y); pcall(function() UIS.MouseIconEnabled = false end); end;
local function updateDrag(input) if isDragging and input.UserInputType == Enum.UserInputType.MouseMovement then pcall(function() MainFrame.Position = UDim2.new(0, input.Position.X - dragOffset.X, 0, input.Position.Y - dragOffset.Y) end); end; end;
local function endDrag(input) if input.UserInputType == Enum.UserInputType.MouseButton1 then isDragging = false; dragOffset = nil; pcall(function() UIS.MouseIconEnabled = true end); end; end;

-- UIä½œæˆé–¢æ•°
local function createUI()
    local existingGui = P.PlayerGui:FindFirstChild("SplashHubControlGui");
    if existingGui then pcall(existingGui.Destroy, existingGui) end;

    local G = Instance.new("ScreenGui"); G.Name = "SplashHubControlGui"; G.Parent = P.PlayerGui;
    if not G.Parent then showNotification("UIã®è¦ªè¨­å®šã«å¤±æ•—ã—ã¾ã—ãŸã€‚", Color3.fromRGB(255, 0, 0)); return end;

    MainFrame = Instance.new("Frame"); MainFrame.Name = "MainFrame"; MainFrame.Size = UDim2.new(0, 450, 0, 40); MainFrame.Position = UDim2.new(0, 10, 0, 10); MainFrame.BackgroundColor3 = Color3.fromRGB(255, 255, 255); MainFrame.BackgroundTransparency = 0.5; MainFrame.Parent = G;

    controlButton = Instance.new("TextButton"); controlButton.Name = "FlyToggle"; controlButton.Size = UDim2.new(0, 150, 1, 0); controlButton.Position = UDim2.new(0, 0, 0, 0); controlButton.BackgroundColor3 = Color3.fromRGB(0, 150, 255); controlButton.TextColor3 = Color3.new(1, 1, 1); controlButton.Text = "SplashHub: é£›è¡Œåˆ‡ã‚Šæ›¿ãˆ"; controlButton.Font = Enum.Font.SourceSansBold; controlButton.TextSize = 18; controlButton.ZIndex = 2; controlButton.Parent = MainFrame;

    local speedLabel = Instance.new("TextLabel"); speedLabel.Name = "SpeedLabel"; speedLabel.Size = UDim2.new(0, 80, 1, 0); speedLabel.Position = UDim2.new(0, 150, 0, 0); speedLabel.BackgroundTransparency = 1; speedLabel.TextColor3 = Color3.new(0, 0, 0); speedLabel.Text = "é€Ÿåº¦èª¿æ•´:"; speedLabel.Font = Enum.Font.SourceSansBold; speedLabel.TextSize = 18; speedLabel.ZIndex = 2; speedLabel.Parent = MainFrame;
    speedTextBox = Instance.new("TextBox"); speedTextBox.Name = "SpeedInput"; speedTextBox.Size = UDim2.new(0, 70, 0.8, 0); speedTextBox.Position = UDim2.new(0, 230, 0.1, 0); speedTextBox.BackgroundColor3 = Color3.new(1, 1, 1); speedTextBox.BackgroundTransparency = 0.3; speedTextBox.TextColor3 = Color3.new(0, 0, 0); speedTextBox.Text = tostring(FLY_SPEED); speedTextBox.Font = Enum.Font.SourceSansBold; speedTextBox.TextSize = 18; speedTextBox.ZIndex = 3; speedTextBox.Parent = MainFrame;

    controlButton.MouseButton1Click:Connect(function() if isFlying then stopFlying() else startFlying() end end);
    speedTextBox.FocusLost:Connect(function(enterPressed)
        if enterPressed or not enterPressed then
            local s, n = pcall(tonumber, speedTextBox.Text);
            if s and n and n > 0 and n < 500 then FLY_SPEED = n; showNotification("é€Ÿåº¦è¨­å®šå®Œäº†", Color3.fromRGB(150, 255, 255)); else showNotification("ç„¡åŠ¹ãªé€Ÿåº¦å€¤", Color3.fromRGB(255, 50, 50)); end
        end
    end);

    MainFrame.InputBegan:Connect(function(i) if i.UserInputType == Enum.UserInputType.MouseButton1 then startDrag(i) end end);
    UIS.InputChanged:Connect(updateDrag);
    UIS.InputEnded:Connect(endDrag);
end;


-- åˆæœŸåŒ–é–¢æ•°
local function initialize()
    -- CharacterAddedã®æ¥ç¶š
    local function setupCharacter(character)
        local H = character:FindFirstChildOfClass("Humanoid");
        if H then pcall(function() H.WalkSpeed = WALK_SPEED end) end;
        if isFlying then stopFlying() end;
        local Root = character:FindFirstChild("HumanoidRootPart");
        if Root then setupGrabDetection(Root) end;
    end;
    if P.Character then setupCharacter(P.Character) end;
    P.CharacterAdded:Connect(setupCharacter);

    -- ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—æ¥ç¶š
    if not flyLoopBinding then flyLoopBinding = RS:BindToRenderStep("FlyMovement", Enum.RenderPriority.Character.Value, updateFlyMovement); end;
    if not antiragdollBinding then antiragdollBinding = RS:BindToRenderStep("AntiRagdoll", Enum.RenderPriority.Camera.Value - 1, updateAntiRagdoll); end;

    -- å®Ÿè¡Œé †åº (é˜²å¾¡ã‚’å…ˆã«ã€UIã‚’æœ€å¾Œã«)
    hookGrabEvents();
    disableTargetScript();
    createUI();
    showNotification("SplashHub èµ·å‹•æˆåŠŸï¼", Color3.fromRGB(0, 255, 0));
end

-- ã‚³ãƒ¼ãƒ‰å…¨ä½“ã‚’å³æ™‚å®Ÿè¡Œé–¢æ•°ã§ãƒ©ãƒƒãƒ—
pcall(initialize)
