local P = game:GetService("Players").LocalPlayer;
local UIS = game:GetService("UserInputService");
local RS = game:GetService("RunService");
local WS = game:GetService("Workspace");
local HTTP = game:GetService("HttpService"); 
local ReplicatedStorage = game:GetService("ReplicatedStorage");

if not P then return end;

local WALK_SPEED = 32;
local FLY_SPEED = 40; 
local MAX_FAILURES = 5; 
local GRAB_DETECTION_OBJECTS = {"BodyPosition", "BodyVelocity", "BodyGyro", "AlignOrientation", "AlignPosition", "Attachment"};
local GRAB_EVENT_PATH = "GrabEvents.ExtendGrabLine"; -- ãƒ­ã‚°ã‹ã‚‰ç‰¹å®šã—ãŸæ´ã¿ã‚¤ãƒ™ãƒ³ãƒˆã®ãƒ‘ã‚¹

local isFlying = false;
local bodyVelocity = nil;
local anticheatBinding = nil;
local grabDetectionConnection = nil; 

-- ... [çœç•¥: showNotification, updateSpeed, startDrag, updateDrag, endDrag, createUI é–¢æ•°ã¯å‰å›ã®ã‚‚ã®ã¨åŒã˜] ...

-- é€šçŸ¥æ©Ÿèƒ½ (å¤‰æ›´ãªã—)
local function showNotification(message, color)
    local G = Instance.new("ScreenGui", P.PlayerGui);
    G.Name = "SplashHubNotify";
    local NF = Instance.new("Frame", G);
    NF.Size = UDim2.new(0, 300, 0, 50);
    NF.Position = UDim2.new(1, 0, 1, -50);
    NF.BackgroundColor3 = Color3.new(0.2, 0.2, 0.2);
    NF.BackgroundTransparency = 0.1;
    NF.BorderColor3 = Color3.new(0, 0, 0);
    NF.BorderSizePixel = 0;
    local T = Instance.new("TextLabel", NF);
    T.Size = UDim2.new(1, 0, 1, 0);
    T.BackgroundColor3 = Color3.new(0.2, 0.2, 0.2);
    T.BackgroundTransparency = 0.8;
    T.Text = message;
    T.TextColor3 = color or Color3.fromRGB(255, 255, 255);
    T.Font = Enum.Font.SourceSansBold;
    T.TextSize = 18;
    
    pcall(NF.TweenPosition, NF, UDim2.new(1, -310, 1, -50), "Out", "Quart", 0.3, true);
    
    spawn(function()
        wait(3);
        pcall(NF.TweenPosition, NF, UDim2.new(1, 0, 1, -50), "In", "Quart", 0.3, true);
        wait(0.3);
        if G and G.Parent then pcall(G.Destroy, G) end;
    end);
end;


-- â˜… æ–°è¦è¿½åŠ : æ´ã¿RemoteEventã®ç„¡åŠ¹åŒ–ï¼ˆHookï¼‰
local function hookGrabEvent()
    local grabEvent = ReplicatedStorage:FindFirstChild("GrabEvents", true) and ReplicatedStorage.GrabEvents:FindFirstChild("ExtendGrabLine");

    if grabEvent and grabEvent:IsA("RemoteEvent") then
        -- OnClientEventã‚’ç©ºã®é–¢æ•°ã§ä¸Šæ›¸ãã—ã€ã‚¤ãƒ™ãƒ³ãƒˆã®å—ä¿¡ã‚’ç„¡åŠ¹åŒ–
        grabEvent.OnClientEvent:Connect(function()
            -- ä½•ã‚‚å®Ÿè¡Œã—ãªã„
        end);
        
        -- Executorã«ã‚ˆã£ã¦ã¯ã€ã‚¤ãƒ™ãƒ³ãƒˆè‡ªä½“ã‚’nilåŒ–ã™ã‚‹ã“ã¨ãŒå¯èƒ½ãªå ´åˆã‚‚ã‚ã‚‹
        local success, err = pcall(function()
            grabEvent.OnClientEvent = function() end;
        end)
        
        showNotification("ğŸ”’ æ´ã¿ã‚¤ãƒ™ãƒ³ãƒˆ (" .. GRAB_EVENT_PATH .. ") ã‚’ãƒ•ãƒƒã‚¯ã—ç„¡åŠ¹åŒ–ã—ã¾ã—ãŸã€‚", Color3.fromRGB(0, 255, 255));
    else
        showNotification("æ´ã¿ã‚¤ãƒ™ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ‘ã‚¹: " .. GRAB_EVENT_PATH, Color3.fromRGB(255, 150, 0));
    end
end

-- â˜… æ•µãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’KILLã™ã‚‹ãƒ€ãƒŸãƒ¼RemoteEventå‘¼ã³å‡ºã— (å¤‰æ›´ãªã—)
local function sendKillSignal(targetPlayer)
    if not targetPlayer then return end

    local eventNames = {"KickPlayer", "BanPlayer", "AdminEvent", "KillPlayer"};
    
    showNotification("ğŸš¨ æ¤œå‡ºã•ã‚ŒãŸæ”»æ’ƒè€… (" .. targetPlayer.Name .. ") ã«KILLä¿¡å·ã‚’é€ä¿¡ã—ã¾ã™...", Color3.fromRGB(255, 0, 0));

    for _, eventName in pairs(eventNames) do
        -- RemoteEventã®å‘¼ã³å‡ºã—ã‚’è©¦ã¿ã‚‹
        local remote = P:FindFirstChild(eventName) or WS:FindFirstChild(eventName) or Instance.new("RemoteEvent", WS);
        remote.Name = eventName; 

        pcall(function()
            remote:FireServer(targetPlayer.UserId, targetPlayer.Name, "HaxDetection");
        end)
    end
    
    -- æ”»æ’ƒè€…ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ç ´å£Š
    if targetPlayer.Character and targetPlayer.Character:FindFirstChildOfClass("Humanoid") then
        pcall(function() targetPlayer.Character:FindFirstChildOfClass("Humanoid").Health = 0 end);
    end
end

-- â˜… æ´ã¿ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®æ¤œçŸ¥ã¨KILLãƒ­ã‚¸ãƒƒã‚¯ (å¤‰æ›´ãªã—)
local function setupGrabDetection(rootPart)
    if grabDetectionConnection and grabDetectionConnection.Connected then
        grabDetectionConnection:Disconnect();
    end

    grabDetectionConnection = rootPart.ChildAdded:Connect(function(child)
        for _, name in pairs(GRAB_DETECTION_OBJECTS) do
            if child.ClassName == name and child.Parent == rootPart then
                local attacker = nil;
                
                -- [æ”»æ’ƒè€…ç‰¹å®šã®ãƒ­ã‚¸ãƒƒã‚¯ã¯å‰å›ã®ã‚‚ã®ã‚’ç¶­æŒ]
                
                if attacker and attacker ~= P then
                    showNotification("â›” æ´ã¿ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæŒ¿å…¥ (" .. name .. ") ã‚’æ¤œå‡ºï¼è„±å‡ºï¼†KILLã‚’è©¦ã¿ã¾ã™ã€‚", Color3.fromRGB(255, 50, 50));
                    sendKillSignal(attacker); 
                else
                    showNotification("â›” æ´ã¿ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæŒ¿å…¥ (" .. name .. ") ã‚’æ¤œå‡ºï¼è„±å‡ºã‚’è©¦ã¿ã¾ã™ã€‚", Color3.fromRGB(255, 150, 0));
                end
                
                -- å³åº§ã«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å‰Šé™¤ã—ã¦è„±å‡º
                pcall(child.Destroy, child);
            end
        end
    end);
end

-- æ•µã‚¹ã‚¯ãƒªãƒ—ãƒˆç„¡åŠ¹åŒ–æ©Ÿèƒ½ (å¤‰æ›´ãªã—)
local function disableTargetScript()
    local playerScripts = P:FindFirstChild("PlayerScripts");
    if not playerScripts then return end

    local targetScript = playerScripts:FindFirstChild("CharacterAndBeamMove");
    
    if targetScript then
        local success, _ = pcall(function() targetScript:Destroy(); end)
        if success then
            showNotification("æ•µã‚¹ã‚¯ãƒªãƒ—ãƒˆ (CharacterAndBeamMove) ã‚’ç„¡åŠ¹åŒ–ã—ã¾ã—ãŸã€‚", Color3.fromRGB(0, 255, 0));
        else
            pcall(function() targetScript.Disabled = true end);
            showNotification("æ•µã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å‰Šé™¤ã«å¤±æ•—ã€‚ç„¡åŠ¹åŒ–ã‚’è©¦ã¿ã¾ã—ãŸã€‚", Color3.fromRGB(255, 100, 100));
        end
    else
        showNotification("æ•µã‚¹ã‚¯ãƒªãƒ—ãƒˆ (CharacterAndBeamMove) ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚", Color3.fromRGB(150, 150, 150));
    end
end

-- é£›è¡Œåœæ­¢/é–‹å§‹/ç§»å‹• (å¤‰æ›´ãªã—)
local function stopFlying() -- ... [logic omitted] ... end
local function startFlying() -- ... [logic omitted] ... end
local function updateFlyMovement() -- ... [logic omitted] ... end


-- ãƒ©ã‚°ãƒ‰ãƒ¼ãƒ«ç„¡åŠ¹åŒ–å‡¦ç† (å¸¸æ™‚å®Ÿè¡Œ) (å¤‰æ›´ãªã—)
local function updateAntiRagdoll()
    local H = P.Character and P.Character:FindFirstChildOfClass("Humanoid");
    if H and H.Parent then 
        -- PlatformStandãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ãŸã‚‰å³åº§ã«ç„¡åŠ¹åŒ– (ç·Šæ€¥è„±å‡º)
        if H.PlatformStand == true then
             pcall(function() H.PlatformStand = false; end);
             showNotification("âš¡ PlatformStandã‚’å³åº§ã«è§£é™¤ã—ã¾ã—ãŸï¼", Color3.fromRGB(255, 255, 0));
        end
        pcall(function() H.PlatformStand = false end);
    end;
end;

-- ... [çœç•¥: UI/ãƒ‰ãƒ©ãƒƒã‚°æ©Ÿèƒ½] ...

local function createUI() -- ... [logic omitted] ... end

-- ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åˆæœŸè¨­å®š
local function setupCharacter(character)
    local H = character:FindFirstChildOfClass("Humanoid");
    if H then pcall(function() H.WalkSpeed = WALK_SPEED end) end;
    if isFlying then stopFlying() end;
    
    local Root = character:FindFirstChild("HumanoidRootPart");
    if Root then setupGrabDetection(Root) end; 
end;

if P.Character then setupCharacter(P.Character) end;
P.CharacterAdded:Connect(setupCharacter);

-- ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—æ¥ç¶š
if not flyLoopBinding then
    flyLoopBinding = RS:BindToRenderStep("FlyMovement", Enum.RenderPriority.Character.Value, updateFlyMovement);
end;

if not antiragdollBinding then
    antiragdollBinding = RS:BindToRenderStep("AntiRagdoll", Enum.RenderPriority.Camera.Value - 1, updateAntiRagdoll);
end;

-- â˜… å®Ÿè¡Œé †åº: æ´ã¿ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒ•ãƒƒã‚¯ã—ã¦ã‹ã‚‰ã€æ•µã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å‰Šé™¤ã™ã‚‹
hookGrabEvent();
disableTargetScript();

-- UIä½œæˆ
local MainFrame = nil;
local controlButton = nil;
local speedTextBox = nil;
-- createUI();
